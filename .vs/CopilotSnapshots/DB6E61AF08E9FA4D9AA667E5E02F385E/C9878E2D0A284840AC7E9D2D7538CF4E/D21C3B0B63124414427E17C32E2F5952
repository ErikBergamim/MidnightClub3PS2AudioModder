#!/usr/bin/env python3
"""
rstm_build.py - Exemplo de estrutura para converter WAV para RSM

Este é um exemplo de estrutura. O script real deve ser fornecido
pelo desenvolvedor ou obtido do projeto original.

Uso: python rstm_build.py input.wav

Parâmetros:
    input.wav  - Arquivo WAV de entrada

Saída: 
    Cria automaticamente input.wav.rsm no mesmo diretório
"""

import sys
import os
import struct
import wave

def build_rsm(wav_path):
    """
    Converte um arquivo WAV para formato RSM.
    O arquivo RSM é criado automaticamente com o nome: input.wav.rsm
    
    Args:
        wav_path: Caminho para o arquivo WAV de entrada
    """
    if not os.path.exists(wav_path):
        print(f"Erro: Arquivo não encontrado: {wav_path}")
        sys.exit(1)
    
    # O arquivo de saída é o WAV + .rsm
    rsm_path = wav_path + ".rsm"
    
    # Lê o arquivo WAV
    try:
        with wave.open(wav_path, 'rb') as wav:
            # Obtém informações do WAV
            channels = wav.getnchannels()
            sample_width = wav.getsampwidth()
            framerate = wav.getframerate()
            n_frames = wav.getnframes()
            
            print(f"WAV Info:")
            print(f"  Canais: {channels}")
            print(f"  Sample Rate: {framerate} Hz")
            print(f"  Sample Width: {sample_width} bytes")
            print(f"  Frames: {n_frames}")
            
            # Lê os dados de áudio
            audio_data = wav.readframes(n_frames)
    except Exception as e:
        print(f"Erro ao ler arquivo WAV: {e}")
        sys.exit(1)
    
    # Cria o arquivo RSM
    try:
        with open(rsm_path, 'wb') as rsm:
            # Header RSM (exemplo simplificado)
            # Magic "RSTM"
            rsm.write(b'RSTM')
            
            # Flags/Version (4 bytes)
            rsm.write(struct.pack('<I', 0))
            
            # Sample Rate (4 bytes, little endian)
            rsm.write(struct.pack('<I', framerate))
            
            # Channels (2 bytes, little endian)
            rsm.write(struct.pack('<H', channels))
            
            # Reserved (2 bytes)
            rsm.write(struct.pack('<H', 0))
            
            # TODO: Adicionar header adicional conforme especificação RSM
            # Este é apenas um exemplo básico
            
            # Dados de áudio
            rsm.write(audio_data)
            
        print(f"✅ Arquivo RSM criado: {rsm_path}")
        print(f"   Tamanho: {os.path.getsize(rsm_path)} bytes")
        
    except Exception as e:
        print(f"Erro ao criar arquivo RSM: {e}")
        sys.exit(1)

def main():
    if len(sys.argv) != 2:
        print("Uso: python rstm_build.py input.wav")
        print("")
        print("O arquivo de saída será criado automaticamente como: input.wav.rsm")
        sys.exit(1)
    
    wav_path = sys.argv[1]
    build_rsm(wav_path)

if __name__ == "__main__":
    main()
